<script src="/socket.io/socket.io.js"></script>
<script>

function isCanvasSupported(){
  var elem = document.createElement('canvas');
  return !!(elem.getContext && elem.getContext('2d'));
}

$(document).ready(function() {

    if(!isCanvasSupported()) {
        $("#canvas-unsupported").show();
        return;
    }
    
    $('#color-choice').miniColors();
    
    $("#color-random").change(function() {
        $('#color-choice').miniColors('disabled', $("#color-random").is(':checked'));
    });
    
    var drawCircle = function(canvas, event) {
        
        var x = event.pageX - canvas.offsetLeft;
        var y = event.pageY - canvas.offsetTop;
        
        var color = ($("#color-random").is(':checked'))
            ? '#'+(0x1000000+(Math.random())*0xffffff).toString(16).substr(1,6)
            : $('#color-choice').val();
        
        var data = {
            "fillStyle": color,
            "x": x,
            "y": y,
            "width": $('#size-choice').val(),
            "height": $('#size-choice').val(),
            "fromCenter": true
        };
        
        socket.emit('draw', data);
        $("canvas").drawEllipse(data);
    }
    
    var socket = io.connect('/canvas');
    
    var mouseDownOnCanvas = false;
    
    $('#canvas').mousedown(function(e) {
        mouseDownOnCanvas = true;
        drawCircle(this, e);
        return false;
    });
    
    $('#canvas').mousemove(function(e) {
        if(mouseDownOnCanvas) {
            drawCircle(this, e);
            return false;
        }
    });
    
    $(document).mouseup(function() {
        mouseDownOnCanvas = false;
    });
    
    $('#share-to-imgur').click(function(event) {
    
        event.preventDefault();
        
        var w = window.open();
        w.document.write('Uploading...');
        
        $.ajax({
            url: 'http://api.imgur.com/2/upload.json',
            type: 'POST',
            dataType: 'json',
            data: {
                type: 'base64',
                key: '8ba822fb5788eca3d187b5505c2cce72',
                image: $('#canvas').getCanvasImage().split(',')[1]
            }
        }).success(function(data) {
            w.location.href = data['upload']['links']['imgur_page'];
        }).error(function() {
            alert('Could not reach api.imgur.com');
            w.close();
        });
    });
	
	////////////////////////////////////////
	// Socket listeners
    
    socket.on('client_count', function(count) {
	
		var oc = $("#online-count");
    
        if(typeof this.previousCount == "undefined") this.previousCount = count;
		if(typeof this.originalColor == "undefined") this.originalColor = oc.css('color');
    
		oc.text(count + (count == 1 ? " person" : " people") + " on this canvas");
        
		var color = this.originalColor;
		
        if(count > this.previousCount) {
            color = "#090";
        } else if (count < this.previousCount) {
            color = "#C00";
        }
        
        $("#online-count").css('color', color).animate({'color': this.originalColor}, 2000);
        this.previousCount = count;
        
    });
    
    socket.on('draw', function(data) {
        $("#canvas").drawEllipse(data);
    });
    
    var disconnectTimer;
	
	socket.on('connect', function(data) {
        clearTimeout(disconnectTimer);
        $("#server-link-lost").slideUp();
    });
	
	socket.on('disconnect', function(data) {
        disconnectTimer = setTimeout(function() {
            $("#server-link-lost").slideDown();
        }, 5000);
    });
    
    socket.on('history', function(data) {
        
		$("#canvas").drawRect({
            'fillStyle': '#FFFFFF',
            x: 0, y: 0,
            width: $("#canvas").width(),
            height: $("#canvas").height(),
            fromCenter: false
        });
		
        for(var n in data) {
            $("#canvas").drawEllipse(data[n]);
        }
		
        $("#canvas").removeClass("loading");
    });
	
	socket.on('canvas_ttl', function(seconds) {
		$("#canvas-ttl-message").toggleClass('alert-info', (seconds > 60));
		$("#canvas-ttl-message").text("The public canvas will reset in " + ((seconds > 60) ? Math.ceil(seconds/60) + " minutes" :  seconds + " seconds"));
	});
    
});

</script>

<style tyle="text/css">
#canvas, #canvas:active, #canvas:focus {
    border: 1px solid #ccc;
    cursor: crosshair;
}

#canvas.loading {
    background: #EEE url("/images/spinner.gif") no-repeat center;
}

.form-narrow .control-label {
    width: 60px;
}

.form-narrow .controls {
    margin-left: 80px;
}

.topbox {
	text-align: center;
}
</style>

<div class="page-header">
	<h1>Canvas <small>Many people drawing at the same time. Typical results.</small></h1>
</div>

<div class="row">
    <div class="span12">
			<div id="canvas-unsupported" class="hide alert alert-error alert-block">
				<h4 class="alert-heading">Oh dear!</h4>
                <p>
                    Looks like your browser doesn't support &lt;canvas&gt;. Sorry.
                </p>
			</div>
			<div id="server-link-lost" class="hide alert alert-warning alert-block">
				<h4 class="alert-heading">Hmm...</h4>
                <p>
                    The connection to the canvas server has been lost. 
                    If this box doesn't disappear soon, try refreshing the page.
                </p>
			</div>
    </div>
</div>

<div class="row">
    <div class="span8">
        <canvas id="canvas" class="loading" width="620" height="485"></canvas>
		<p>
			<% if(!privateCanvas) { %>
				<div class="alert alert-info" id="canvas-ttl-message">
					The public canvas will reset once every 15 minutes.
				</div>
			<% } else { %>
				<div class="alert alert-success">
					<strong>Note:</strong> The contents of this canvas will be lost once everyone leaves!
				</div>
			<% } %>
		</p>
    </div>
    <div class="span4">
    
        <div class="well topbox">
			<p><h3 id="online-count">1 person on this canvas</h3></p>
			<% if(privateCanvas) { %>
				<p style="margin-left: 40px; margin-right: 40px;">
					<a href="<%= originalUrl %>">Share this link to invite people to this canvas</a>
				</p>
				<p>
					<a class="btn btn-danger" href="/">Back to public canvas</a>
				</p>
			<% } else { %>
				<p>
					<a class="btn btn-primary btn-large" href="<%= genurl %>">Start your own canvas</a>
				</p>
			<% } %>
        </div>
        
        <form class="well form-horizontal form-narrow">
            <fieldset>
                <div class="control-group">
                    <label class="control-label" for="color-choice">Color</label>
                    <div class="controls">
                        <input id="color-choice" type="text" class="input-mini" value="#000000" />
                        <label class="checkbox">
                            <input type="checkbox" id="color-random" />
                            Random
                        </label>
                    </div>
                </div>
                <div class="control-group">
                    <label class="control-label" for="size-choice">Size</label>
                    <div class="controls">
                        <select id="size-choice" class="input-small">
                            <option>5</option>
                            <option>10</option>
                            <option selected>25</option>
                            <option>50</option>
                        </select>
                    </div>
                </div>
                <div class="control-group">
                    <div class="controls">
                        <button class="btn" id="share-to-imgur" href="#">
                            <i class="icon-picture"></i>
                            Share snapshot
                        </button>
                    </div>
                </div>
            </fieldset>
        </form>
    </div>
</div>
